# 紫微斗数模块 - 缺失功能分析

## 一、四化系统 ⚠️ **部分完成**

### 1.1 生年四化（本命四化）✅ **已完成**
- ✅ 根据出生年干确定禄权科忌四颗化星
- ✅ 四化星已标注在星耀上
- ✅ 实现位置：`get_si_hua_table(TianGan year_gan)`

### 1.2 大限四化（运限四化）✅ **已完成**
- ✅ 根据大限天干确定禄权科忌
- ✅ 存储在 `DaXianData::si_hua`
- ✅ 实现位置：`zi_wei_horoscope.cpp`

### 1.3 流年/月/日/时四化 ✅ **已完成**
- ✅ 流年四化：根据流年天干
- ✅ 流月四化：根据流月天干
- ✅ 流日四化：根据流日天干
- ✅ 流时四化：根据流时天干

### 1.4 宫干四化（飞星四化）❌ **缺失**

**重要性**：⭐⭐⭐⭐⭐ 极其重要

#### 概念
每个宫位的天干都可以产生四化，这些四化会飞入其他宫位，形成"飞化"。这是紫微斗数高级分析的核心。

#### 缺失内容
```cpp
// 需要实现的功能
struct GongGanSiHua {
    TianGan gong_gan;              // 宫位天干
    map<SiHua, int> si_hua_gong;   // 四化飞入的宫位
    map<SiHua, string> si_hua_xing; // 四化的星耀名称
};

// 每个宫位都有宫干四化
array<GongGanSiHua, 12> gong_gan_si_hua;
```

#### 应用场景
- **命宫干四化**：代表自己对其他宫位的影响
- **财帛宫干四化**：财运对其他宫位的影响
- **疾厄宫干四化**：健康对其他宫位的影响
- 等等...

#### 参考实现（iztro）
```typescript
// FunctionalPalace.ts
mutagedPlaces = () => {
  const { heavenlyStem } = this;
  const stars = mutagensToStars(heavenlyStem, ['禄', '权', '科', '忌']);
  return stars.map((star) => astrolabe.star(star).palace());
};
```

### 1.5 自化 ❌ **缺失**

**重要性**：⭐⭐⭐⭐ 非常重要

#### 概念
当宫位的天干四化飞入的星耀恰好在本宫，称为"自化"。

#### 类型
- **自化禄**：表示自给自足、保守
- **自化权**：表示权力在自己手中、独立
- **自化科**：表示自我肯定、清高
- **自化忌**：表示自我纠结、内耗

#### 需要实现
```cpp
struct ZiHuaInfo {
    bool has_zi_hua;           // 是否有自化
    vector<SiHua> zi_hua_types; // 自化类型列表
};

// 判断某宫位是否自化
bool has_zi_hua(int gong_index, SiHua si_hua_type);
```

---

## 二、宫位分析系统 ❌ **完全缺失**

### 2.1 三方四正 ❌ **缺失**

**重要性**：⭐⭐⭐⭐⭐ 极其重要

#### 概念
- **本宫**：目标宫位本身
- **对宫**：与本宫相对（相差6宫）
- **三合宫**：财帛位（+4宫）、官禄位（+8宫）

#### 需要实现
```cpp
struct SanFangSiZheng {
    int ben_gong_index;      // 本宫索引
    int dui_gong_index;      // 对宫索引（+6）
    int cai_bo_index;        // 财帛位（+8）
    int guan_lu_index;       // 官禄位（+4）
    
    // 获取三方四正所有星耀
    vector<StarData> get_all_stars() const;
    
    // 判断三方四正是否有某星
    bool has_star(const string& star_name) const;
};

// 获取某宫位的三方四正
SanFangSiZheng get_san_fang_si_zheng(int gong_index);
```

#### 应用
- 格局判断必须看三方四正
- 星耀吉凶需要三方四正配合
- 宫位强弱看三方四正

### 2.2 邻宫与夹宫 ❌ **缺失**

**重要性**：⭐⭐⭐ 重要

#### 概念
- **前一宫/后一宫**：相邻宫位
- **夹宫**：左右两宫夹持某宫

#### 应用
- **夹命格局**：如左右邻宫有吉星夹命
- **夹制**：凶星夹某宫

---

## 三、格局系统 ❌ **完全缺失**

**重要性**：⭐⭐⭐⭐⭐ 极其重要

### 3.1 富贵格局

需要实现的格局（部分列表）：

#### 大格局
- ❌ **紫府同宫**：紫微天府在同一宫
- ❌ **府相朝垣**：天府天相在三方四正
- ❌ **君臣庆会**：紫微、天相、天府等组合
- ❌ **机月同梁格**：天机、太阴、天同、天梁组合
- ❌ **日月并明**：太阳太阴在卯酉宫
- ❌ **阳梁昌禄**：太阳、天梁、文昌、禄存组合
- ❌ **明珠出海**：太阴在酉宫
- ❌ **月朗天门**：太阴在亥宫

#### 权贵格局
- ❌ **三奇嘉会**：化禄、化权、化科会聚
- ❌ **科权禄夹**：科权禄夹命或夹财
- ❌ **双禄夹命**：禄存、化禄夹命
- ❌ **左右夹命/财**：左辅右弼夹持

#### 凶格
- ❌ **铃昌陀武**：铃星、文昌、陀罗、武曲同宫
- ❌ **巨机同宫**：巨门天机同宫（辰戌宫）
- ❌ **马头带箭**：擎羊在午宫守命
- ❌ **羊陀夹忌**：擎羊、陀罗夹化忌
- ❌ **火铃夹命/财**：火星铃星夹持

### 3.2 实现结构
```cpp
enum class GeJuType {
    // 大格局
    ZiFuTongGong,      // 紫府同宫
    FuXiangChaoYuan,   // 府相朝垣
    JunChenQingHui,    // 君臣庆会
    // ... 更多格局
};

struct GeJuInfo {
    GeJuType type;
    string name;           // 格局名称
    string description;    // 格局说明
    bool is_ji;           // 是否为吉格
    int score;            // 格局分数
};

// 判断命盘格局
vector<GeJuInfo> analyze_ge_ju(const ZiWeiResult& result);
```

---

## 四、星曜组合分析 ❌ **部分缺失**

### 4.1 双星组合 ❌ **缺失**

**重要性**：⭐⭐⭐⭐ 非常重要

#### 紫微系组合
- 紫微 + 天府/天相/贪狼/破军/七杀等
- 不同组合有不同意义

#### 天府系组合
- 天府 + 武曲/廉贞等

#### 需要实现
```cpp
struct ShuangXingZuHe {
    ZhuXing xing1;
    ZhuXing xing2;
    string zu_he_name;     // 组合名称
    string xing_zhi;       // 组合性质
    string description;    // 组合说明
};

// 分析双星组合
vector<ShuangXingZuHe> analyze_shuang_xing(int gong_index);
```

### 4.2 星耀互涉 ❌ **缺失**

#### 吉凶配置
- 主星 + 六吉星（左右昌曲魁钺）
- 主星 + 六煞星（羊陀火铃空劫）
- 吉凶混杂的影响

---

## 五、宫位飞化分析 ❌ **完全缺失**

**重要性**：⭐⭐⭐⭐⭐ 极其重要（高级分析核心）

### 5.1 宫位飞化

#### 概念
从某个宫位的天干四化，飞到另一个宫位，建立宫位之间的联系。

#### 例子
- **命宫干化禄入财帛**：自己努力可以赚到钱
- **财帛宫干化忌入命**：钱财带来困扰
- **夫妻宫干化权入官禄**：配偶对事业有掌控权

### 5.2 需要实现
```cpp
struct GongWeiFeiHua {
    int from_gong;         // 起飞宫位
    int to_gong;           // 落宫
    SiHua si_hua_type;     // 四化类型
    string star_name;      // 化星名称
    string meaning;        // 飞化含义
};

// 查询某宫飞化到其他宫的情况
vector<GongWeiFeiHua> get_fei_hua_from_gong(int gong_index);

// 查询某宫被哪些宫飞化
vector<GongWeiFeiHua> get_fei_hua_to_gong(int gong_index);

// 判断是否从A宫飞化到B宫
bool flies_to(int from_gong, int to_gong, SiHua si_hua_type);
```

### 5.3 飞化层次

#### 一层飞化
- A宫干四化 → B宫

#### 二层飞化（飞化之飞化）
- A宫干四化 → B宫 → B宫干四化 → C宫

#### 三层飞化
- A → B → C → D

#### 四层飞化（飞化回本宫）
- 命宫 → 兄弟 → 夫妻 → 子女 → 命宫（回到命宫）

---

## 六、专项功能缺失

### 6.1 星耀亮度系统 ✅ **部分完成**

- ✅ 主星亮度已实现（庙旺得平陷不利）
- ❌ 辅星亮度缺失
- ❌ 煞星亮度缺失
- ❌ 杂耀亮度缺失

### 6.2 空宫处理 ❌ **缺失**

**重要性**：⭐⭐⭐ 重要

#### 概念
某宫无主星，需要借对宫主星论命。

#### 需要实现
```cpp
// 判断是否空宫
bool is_kong_gong(int gong_index);

// 借星安宫
vector<StarData> jie_xing_an_gong(int kong_gong_index);
```

### 6.3 星耀特性标注 ❌ **缺失**

#### 需要的星耀特性
- **桃花星**：贪狼、廉贞、咸池、红鸾、天喜等
- **财星**：武曲、天府、太阴等
- **权星**：紫微、天府、太阳等
- **文星**：文昌、文曲、天魁、天钺等
- **寿星**：天梁、天寿等
- **驿马星**：天马、驿马等

### 6.4 神煞系统增强 ⏳ **部分完成**

- ✅ 长生12神
- ✅ 博士12神
- ✅ 岁前12神
- ✅ 将前12神
- ❌ 流羊、流陀、流昌、流曲等流年神煞的详细作用说明
- ❌ 神煞组合效果

---

## 七、输出和工具功能

### 7.1 命盘可视化 ❌ **缺失**

- ❌ 命盘方格图生成
- ❌ 三方四正连线图
- ❌ 飞化箭头图

### 7.2 分析报告 ❌ **缺失**

- ❌ 命格强弱分析
- ❌ 格局吉凶评分
- ❌ 六亲宫位分析
- ❌ 流年运势分析
- ❌ 事业财运分析
- ❌ 婚姻感情分析

### 7.3 JSON/XML导出 ⏳ **部分完成**

- ✅ 基本结构可以序列化
- ❌ 完整的分析结果导出
- ❌ 标准格式定义

---

## 八、优先级排序

### 🔥 极高优先级（必须实现）

1. **宫干四化（飞星四化）** - 高级分析核心
2. **三方四正系统** - 基础分析必需
3. **自化判断** - 重要分析指标
4. **格局判断系统** - 命盘评价核心

### ⭐ 高优先级（重要功能）

5. **宫位飞化分析** - 宫位互涉分析
6. **双星组合分析** - 星耀意义解读
7. **空宫借星** - 空宫处理
8. **星耀特性系统** - 星耀分类

### 📋 中优先级（增强功能）

9. **辅煞杂耀亮度** - 完善星耀系统
10. **神煞详细说明** - 神煞意义
11. **命盘可视化** - 用户体验
12. **分析报告生成** - 实用工具

---

## 九、实现建议

### 阶段一：核心四化系统（1-2周）
```cpp
// 1. 宫干四化
module ZhouYi.ZiWei.SiHua;

// 2. 自化判断
bool has_self_mutagen(int gong_index, SiHua type);

// 3. 飞化查询
vector<FeiHuaInfo> get_fei_hua_relations();
```

### 阶段二：宫位分析系统（1周）
```cpp
// 1. 三方四正
struct SanFangSiZheng { ... };

// 2. 夹宫分析
struct JiaGongInfo { ... };
```

### 阶段三：格局系统（2-3周）
```cpp
// 1. 格局判断引擎
class GeJuAnalyzer {
    vector<GeJuInfo> analyze(const ZiWeiResult& pan);
};

// 2. 逐步添加各种格局规则
```

### 阶段四：高级功能（2周）
```cpp
// 1. 多层飞化
// 2. 综合分析
// 3. 报告生成
```

---

## 十、参考资料

### 开源项目
- **iztro (TypeScript)**: https://github.com/SylarLong/iztro
  - 完整的四化系统
  - 飞化分析
  - 格局判断

### 传统典籍
- 《紫微斗数全书》：格局总论
- 《骨髓赋》：格局精要
- 《女命骨髓赋》：女命格局
- 《太微赋》：星情论述

### 现代著作
- 慧心斋主《紫微斗数讲义》
- 王亭之《中州派紫微斗数》
- 陆斌兆《紫微斗数精成》

---

## 总结

当前紫微斗数模块已完成：
- ✅ 基本排盘功能（地盘）
- ✅ 所有星耀定位（主星、辅星、煞星、杂耀、神煞）
- ✅ 天地人三盘（大限、流年、流月、流日、流时）
- ✅ 生年四化、大限四化、流年四化

**核心缺失**：
- ❌ 宫干四化（飞星四化）⭐⭐⭐⭐⭐
- ❌ 三方四正系统 ⭐⭐⭐⭐⭐
- ❌ 自化判断 ⭐⭐⭐⭐
- ❌ 格局判断系统 ⭐⭐⭐⭐⭐
- ❌ 宫位飞化分析 ⭐⭐⭐⭐⭐

建议优先实现四化系统和三方四正，这是紫微斗数分析的基础。

